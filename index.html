<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0; /* Remove default margin */
            padding-top: 50px; /* Top padding */
        }
    
        .container {
            width: 400px; /* Set container width */
            margin: 0 auto; /* Center alignment */
        }
    
        .control {
            display: flex;
            justify-content: flex-start; /* Left align */
            align-items: center;
            margin-top: 20px;
        }
    
        .control label {
            margin-right: 10px; /* Space between label and input */
            flex-basis: 200px; /* Label width */
            text-align: right; /* Right align label */
        }
    
        .control input[type="number"], 
        .control input[type="range"] {
            width: 50px; /* Input width */
            height: 20px; /* Input height */
            margin: 0 5px; /* Input left and right margin */
            text-align: center; /* Center align input text */
            border-radius: 0; /* No rounding */
            border: 2px solid #bbb; /* Add border */
            padding: 0;
        }
    
        button {
            outline: none;
            width: 24px;
            height: 24px;
            border: none;
            background-color: #bbb;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin: 0 5px;
            border-radius: 0;
            padding: 0;
        }
    
        button:active {
            background-color: #ddd; /* Change background color on press */
        }
    
        #volume {
            outline: none;
            width: 118px;
            height: 12px;
        }
    
        .frequency {
            font-size: 24px;
            margin-top: 20px;
            white-space: pre-line;
        }
        .control input[type="range"] {
            -webkit-appearance: none; /* Remove default style (for Webkit browsers) */
            appearance: none; /* Remove default style */
            width: 100%; /* Set to 100% width */
            height: 20px; /* Set height */
            border-radius: 0; /* Ensure no rounding */
        }

        .control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Remove default style */
            appearance: none; /* Remove default style */
            width: 12px; /* Custom thumb width */
            height: 20px; /* Custom thumb height */
            background: #bbb; /* Custom thumb background color */
            border-radius: 0; /* Ensure no rounding */
            cursor: pointer; /* Custom cursor */
        }

        .control input[type="range"]::-moz-range-thumb {
            width: 12px; /* Custom thumb width */
            height: 20px; /* Custom thumb height */
            background: #bbb; /* Custom thumb background color */
            border-radius: 0; /* Ensure no rounding */
            cursor: pointer; /* Custom cursor */
        }

        .control input[type="range"]::-ms-thumb {
            width: 12px; /* Custom thumb width */
            height: 20px; /* Custom thumb height */
            background: #bbb; /* Custom thumb background color */
            border-radius: 0; /* Ensure no rounding */
            cursor: pointer; /* Custom cursor */
        }

        /* Hide number input's up and down arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Chrome and Safari */
            margin: 0; /* Remove default margin */
        }

        /* Hide range input's default style */
        input[type="range"] {
            -webkit-appearance: none; /* Remove default style (for Webkit browsers) */
            appearance: none; /* Remove default style */
        }
    </style>
</head>
<body>
    <h1>19-Tone Equal Temperament</h1>
    <div class="container"> 

        <div class="control">
            <label for="reference">Reference Frequency (Hz)</label>
            <input type="number" id="reference" step="1" min="1">
            <button id="refIncrease">+</button>
            <button id="refDecrease">-</button>
        </div>

        <div class="control">
            <label for="octave">Octave</label>
            <input type="number" id="octave" step="1">
            <button id="octaveIncrease">+</button>
            <button id="octaveDecrease">-</button>
        </div>

        <div class="control">
            <label for="volume">Volume</label>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
        </div>

        <p class="frequency"><span id="frequency"></span></p>
    </div>

    <script>
        let reference = 440; // Reference frequency
        document.getElementById('reference').value = reference;
        const toneNumber = 19; // 19-Tone equal temperament
        let octave = 4; // Octave number
        document.getElementById('octave').value = octave;

        function frequency(key) {
            return reference * 2**(key/toneNumber + octave - 4);
        }
        
        function updateFrequencyDisplay() {
            const activeFrequencies = Array.from(activeKeys)
                .map(key => Math.round(frequency(keys[key])))
                .filter(freq => freq !== undefined)
                .sort((a, b) => a - b);
            const display = activeFrequencies.map(freq => `${freq} Hz`).join('\n');
            document.getElementById('frequency').textContent = display;
        }

        function updateActiveFrequencies() {
            activeKeys.forEach(activeKey => {
                const activeFrequency = frequency(keys[activeKey]);
                if (oscillators[activeKey]) {
                    oscillators[activeKey].frequency.setValueAtTime(activeFrequency, audioContext.currentTime);
                }
            });
        }

        const keys = {
            "q": -14,
            "a": -13,
            "z": -12,

            "w": -11,
            "s": -10,
            "x": -9,

            "e": -8,
            "d": -7,

            "r": -6,
            "f": -5,
            "v": -4,

            "t": -3,
            "g": -2,
            "b": -1,

            "y": 0,
            "h": 1,
            "n": 2,

            "u": 3,
            "j": 4,
            
            "i": 5,
            "k": 6,
            ",": 7,

            "o": 8,
            "l": 9,
            ".": 10,

            "p": 11,
            ";": 12,

            "[": 13,
            "'": 14,
            "/": 15,

            "]": 16,

            "\\": 19,

            "`": 22,

            "1": 24,
            "2": 27,
            "3": 30,
            "4": 32,
            "5": 35,
            "6": 38,
            "7": 41,
            "8": 43,
            "9": 46,
            "0": 49,
            "-": 51,
            "=": 54,
        };

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillators = {};
        const gainNodes = {};  // 每个音符对应一个独立的 GainNode
        const activeKeys = new Set();

        window.addEventListener('keydown', (event) => {
            if (event.target.tagName.toLowerCase() === 'input') {
                if (event.key === 'Enter') {
                    event.target.blur(); // 取消选中输入框
                    return; 
                }
            }

            const key = event.key;
            const freq = frequency(keys[key]);
            
            if (freq) {
                if (!activeKeys.has(key)) {
                    activeKeys.add(key);

                    // 创建独立的 GainNode
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = parseFloat(document.getElementById('volume').value) ** 2;
                    gainNode.connect(audioContext.destination);
                    gainNodes[key] = gainNode;

                    const oscillator = audioContext.createOscillator();
                    oscillator.type = 'triangle'; // Waveform type
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    oscillator.connect(gainNode); // Connect oscillator to gain node
                    oscillator.start();

                    oscillators[key] = oscillator;
                } else {
                    // Update frequency of the pressed key
                    oscillators[key].frequency.setValueAtTime(freq, audioContext.currentTime);
                }

                updateFrequencyDisplay();
            } else {
                switch (key) {
                    case 'ArrowDown': 
                        octave--;
                        document.getElementById('octave').value = octave;
                        
                        // Update the frequency of all active oscillators
                        updateActiveFrequencies();
                        updateFrequencyDisplay();
                        break;
                    case 'ArrowUp': 
                        octave++;
                        document.getElementById('octave').value = octave;
                        
                        // Update the frequency of all active oscillators
                        updateActiveFrequencies();
                        updateFrequencyDisplay();
                        break;
                }
            }
        });

        window.addEventListener('keyup', (event) => {
            const key = event.key;
            if (oscillators[key]) {
                // 开始独立衰减
                gainNodes[key].gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2); // 在0.5秒内衰减至0
                oscillators[key].stop(audioContext.currentTime + 0.2); // 0.5秒后停止振荡器
                delete oscillators[key];
                delete gainNodes[key];
                activeKeys.delete(key);
                updateFrequencyDisplay();
            }

            document.activeElement.blur();
        });
        
        document.getElementById('volume').addEventListener('input', (event) => {
            const value = event.target.value ** 2;
            activeKeys.forEach(key => {
                if (gainNodes[key]) {
                    gainNodes[key].gain.value = value; // 更新当前活跃按键的增益
                }
            });
        });

        document.getElementById('reference').addEventListener('input', (event) => {
            reference = parseFloat(event.target.value);
            updateActiveFrequencies(); 
            updateFrequencyDisplay();
        });
        document.getElementById('refIncrease').addEventListener('click', () => {
            reference++;
            document.getElementById('reference').value = reference;
            updateActiveFrequencies();
            updateFrequencyDisplay();
            document.activeElement.blur();
        });
        document.getElementById('refDecrease').addEventListener('click', () => {
            if (reference > 1) reference--;
            document.getElementById('reference').value = reference;
            updateActiveFrequencies();
            updateFrequencyDisplay();
            document.activeElement.blur();
        });

        document.getElementById('octave').addEventListener('input', (event) => {
            octave = parseInt(event.target.value);
            updateActiveFrequencies(); 
            updateFrequencyDisplay();
        });
        document.getElementById('octaveIncrease').addEventListener('click', () => {
            octave++;
            document.getElementById('octave').value = octave;
            updateActiveFrequencies(); 
            updateFrequencyDisplay();
            document.activeElement.blur();
        });
        document.getElementById('octaveDecrease').addEventListener('click', () => {
            octave--;
            document.getElementById('octave').value = octave;
            updateActiveFrequencies(); 
            updateFrequencyDisplay();
            document.activeElement.blur();
        });

        window.addEventListener('blur', () => {
            activeKeys.forEach(key => {
                if (oscillators[key]) {
                    oscillators[key].stop();
                    delete oscillators[key];
                    delete gainNodes[key];
                }
            });
            activeKeys.clear(); 
            updateFrequencyDisplay(); 
        });

        window.addEventListener('contextmenu', (event) => {
            activeKeys.forEach(key => {
                if (oscillators[key]) {
                    oscillators[key].stop();
                    delete oscillators[key];
                    delete gainNodes[key];
                }
            });
            activeKeys.clear(); 
            updateFrequencyDisplay(); 
        });
    </script>
</body>
</html>
